# Прогноз цен на криптовалюты - дипломный проект

## Дипломный проект магистратуры ФКН ВШЭ "Машинное обучение и высоконагруженные системы"

Проект выполнил: Юсупов Шохрух Шухратжонович, студент 2-го курса магистратуры ФКН ВШЭ

Руководитель: Хажгериев Мурат Анзорович, ML consultant, The Paige

## Архитектура сервиса

Этот проект предоставляет веб-сервис для прогнозирования цены на криптовалюту  Bitcoin (BTC), используя комбинацию анализа временных рядов и моделей машинного обучения.   

![Архитектура](https://github.com/Shoxiing/for/blob/main/archt.png)

Сервис состоит из нескольких компонентов:

- **Airflow** : оркестрирование - dag airflow запускает скрипт в 00:00 по UTC ежедневно.
- **Binance API** : данные передаются на модели: DL модель, а также в базу данных на PostgreSQL.
- **База данных (PostgreSQL)** : имеет в себе 2 таблицы: одна для прогнозов моделей и вторая для хранения и наполнения датасета.
- **DL Model Predict** : в данной работе используется DL модель: предобученная FNN (4-layer), данные от Binance API перед подачей в модель подготавливаются и передаются для получения прогноза в режиме инференса. Прогноз отправляется в БД.
- **3x ARIMA Fit and Predict** : модели ARIMA обращаются к датасету в БД для обучения, используют наблюдение полученной последней цены от API Binance для выдачи прогноза цены через 24 часа.
- **Select Prediction** : выбор прогноза от моделей на завтрашний день - для выбора наиболее точного прогноза из нескольких моделей считается ошибка MAE по предыдущему прогнозу цены BTC .Выбранный прогноз отправляется в БД.
- **Telegram Bot** : пользователь запрашивает прогноз цены BTC в долларах США, отправляется SQL запрос на БД, в ответ пользователь получает прогноз на завтрашний день в виде цены и её направления (повышение/понижение).



## Описание используемых моделей
Для обучения использовалась два датасета: 
- Binance API - ежедневные цены с различными видами объемов торгов, количеством сделок, период данных: 01-09-2019 - 01-06-2024.
- Объединенные данные по ценам Binance API и данные с оценкой новостей NLP - моделью (BART-large-mnli) с API alphavantage.co, период данных: 01-03-2022 - 01-06-2024.

Прогнозирование цен в сервисе осуществляется моделями:
- Для прогноза направления цены (задача классификации) использовалась DL-модель 4-х слойная FNN (accuracy ~ 0.73): подобранные гиперпараметры weight decay = 0.0001 и lr = 0.1, показавшая наилучшее качество. 
- Для прогноза цены (задача регрессии) 3 SARIMAX модели с различной предобработкой входных данных: без предобработки, с логарифмированием, с преобразованием Бокса-Кокса различными параметрами (p, d, q)x(P, D, Q) - без учета экзогенных факторов, так как такие модели показали лучшее качество.


EDA и обучение моделей на датасете Binance API [здесь](notebooks%20-%20EDA%20and%20model%20selection/model_selection.ipynb).

Обучение моделей на датасете Binance API и данные с оценкой новостей NLP - моделью  [здесь](notebooks%20-%20EDA%20and%20model%20selection/model_selection%20-%20with%20estimate%20news%20data.ipynb)

Выгрузка данных из Alphantage.co API и применение модели BART-large-mnli [здесь](notebooks%20-%20EDA%20and%20model%20selection/nlp_dataset.ipynb)



## Метрики моделей на тестовой выборке в задаче классификации (повышение/понижение цены)


Dataset: Biniace API
|  Модель     | Catboost    | XGBoost     | FNN         | LogReg      | LSTM      |                  
|-------------|-------------|-------------|------------ |-------------|-----------|
| Accuracy    | 0.47        | 0.5         |  0.73       | 0.63        | 0.5       |


Dataset: Binance API + Alphantage.co (with estimate news nlp model)

|  Модель     | Catboost    | XGBoost     | FNN         | LogReg      | LSTM      |                  
|-------------|-------------|-------------|------------ |-------------|-----------|
| Accuracy    | 0.5         | 0.5         |  0.6        | 0.63        | 0.5       |



## Структура проекта
- в содержит docker файл docker-compose.yaml для развертывания проекта целиком ( Airflow, БД к ней и БД для проекта, и сам tg_bot)
- **dags_airflow**: dag_01.py - содержит DAG файл для запуска пайплайна в Airflow, functions.py - функции для работы пайплайна, dockerfile, в папке [models](dags_airflow/models) находится предобученная модель FNN, используемая для прогноза.
- **notebooks - EDA and model selection**: Jupyter ноутбуки с разведочным анализом данных (EDA), предобработкой данных, обучением и выбора моделей.
- **tg_bot_crypto**: код Telegram бота, который отправляет прогнозы пользователям.


### Стек:

- Docker, Docker Compose
- Python 3.11
- Apache Airflow
- PostgreSQL

### Алгоритм запуска локально веб-серивса по прогнозу цены BTC

1. **Клонируйте репозиторий:**

    ```sh
    git clone https://github.com/Shoxiing/hse_forecast.git
    ```

2. **Развертывание проекта в docker:**

    ```sh
    docker-compose up -d
    ```
3. В БД загрузить dataset.csv [скачать](https://drive.google.com/file/d/167KvpGBYilRRi6ej3HWP-Nv_i9Ix8AT_/view?usp=drive_link) для предварительного наполнения датасета и обучения ARIMA моделей:
   
    Один из способов:

   ```python
     import pandas as np
     from sqlalchemy import create_engine

     dataset = pd.read_csv(csv_path)
   
     engine = create_engine('postgresql+psycopg2://admin:root@127.0.0.1:5432/postgres') 
     dataset.to_sql('dataset', engine, if_exists='append', index=False)
   
    ```


